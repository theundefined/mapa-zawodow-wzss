<!DOCTYPE html>
<html>
<head>
    <title>Mapa Zawod贸w WZSS</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { font-family: sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; color: #333; }
        h1 { text-align: center; }
        #map { height: 600px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px; }
        
        .filters { 
            background: #f8f9fa; 
            padding: 20px; 
            margin-bottom: 20px; 
            border-radius: 8px; 
            border: 1px solid #e9ecef;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label { font-weight: bold; }

        .club-selector {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            padding: 10px;
            background: white;
            min-width: 250px;
            border-radius: 4px;
        }
        
        .club-selector label {
            display: block;
            cursor: pointer;
            font-weight: normal;
            margin-bottom: 4px;
        }
        
        .club-selector label:hover {
            background-color: #f1f3f5;
        }

        button {
            padding: 8px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #5a6268; }

        .date-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .footer { margin-top: 40px; font-size: 0.8em; color: #666; text-align: center; padding: 20px; border-top: 1px solid #eee; }
        
        /* Table Styles */
        #clubs-table-container {
            margin-top: 30px;
            overflow-x: auto;
        }
        table.clubs-table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        table.clubs-table th, table.clubs-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }
        table.clubs-table th {
            background-color: #e9ecef;
            color: #495057;
        }
        table.clubs-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        table.clubs-table tr:hover {
            background-color: #f1f3f5;
        }
        .ical-btn {
            background-color: #28a745;
        }
        .ical-btn:hover {
            background-color: #218838;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 140px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 150%;
            left: 50%;
            margin-left: -75px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>

<h1>Mapa Zawod贸w WZSS</h1>

<div class="filters">
    <div class="filter-group">
        <label>Wybierz kluby:</label>
        <div id="club-checkboxes" class="club-selector">
            <!-- Checkboxes injected here -->
        </div>
        <div style="display: flex; gap: 5px;">
            <button class="secondary" onclick="selectAllClubs(true)" style="font-size: 0.8em; flex: 1;">Zaznacz wszystkie</button>
            <button class="secondary" onclick="selectAllClubs(false)" style="font-size: 0.8em; flex: 1;">Odznacz wszystkie</button>
        </div>
    </div>

    <div class="filter-group">
        <label for="start-date">Data od:</label>
        <input type="date" id="start-date">
        <label for="end-date">Data do:</label>
        <input type="date" id="end-date">
        <div class="date-buttons">
            <button class="secondary" onclick="setDateRange('next7days')">7 dni</button>
            <button class="secondary" onclick="setDateRange('next14days')">14 dni</button>
            <button class="secondary" onclick="setDateRange('currentMonth')">Ten msc</button>
            <button class="secondary" onclick="setDateRange('nextMonth')">Przyszy msc</button>
        </div>
    </div>
    
    <div class="filter-group" style="align-self: flex-end;">
        <button onclick="applyFilters()" style="padding: 10px 20px; font-weight: bold;">Filtruj</button>
        <button class="secondary" onclick="resetMapView()">Resetuj widok</button>
        <button class="secondary" onclick="showUserLocation()">Moja lokalizacja</button>
    </div>
</div>

<div id="map"></div>

<div id="clubs-table-container">
    <h2>Zestawienie dla wybranych klub贸w</h2>
    <table class="clubs-table" id="clubs-table">
        <thead>
            <tr>
                <th>Klub</th>
                <th>Najbli偶sze zawody</th>
                <th>Kalendarz</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows injected via JS -->
        </tbody>
    </table>
</div>

<div class="footer">
    Ostatnia aktualizacja: <span id="last-updated"></span> | 殴r贸do danych: <a href="https://portal.wzss.pl/competitions/current" target="_blank">portal.wzss.pl</a>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    const initialCenter = [52.4064, 16.9252];
    const initialZoom = 8;
    const map = L.map('map').setView(initialCenter, initialZoom); 

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    let locations = [];
    const markers = L.layerGroup().addTo(map);
    let userLocationMarker;

    const months = {'sty': 0, 'lut': 1, 'mar': 2, 'kwi': 3, 'maj': 4, 'cze': 5, 'lip': 6, 'sie': 7, 'wrz': 8, 'pa藕': 9, 'lis': 10, 'gru': 11};

    // Robust date parser
    function parseDate(dateStr) {
        if (!dateStr) return null;
        
        // Find year
        const yearMatch = dateStr.match(/(\d{4})/);
        const year = yearMatch ? parseInt(yearMatch[0], 10) : new Date().getFullYear();
        
        // Find month
        let month = -1;
        const lowerDate = dateStr.toLowerCase();
        for (const m in months) {
            if (lowerDate.includes(m)) {
                month = months[m];
                break;
            }
        }
        
        // Find day (first number)
        const dayMatch = dateStr.match(/^(\d+)/);
        const day = dayMatch ? parseInt(dayMatch[0], 10) : 1;
        
        if (month > -1) {
            return new Date(year, month, day);
        }
        return null;
    }

    // Parse date for iCal (handling ranges roughly by taking the start)
    function generateSlug(text) {
        // Simple slugify consistent with Python script
        const replacements = {
            '': 'a', '': 'c', '': 'e', '': 'l', '': 'n', '贸': 'o', '': 's', '藕': 'z', '偶': 'z',
            '': 'A', '': 'C', '': 'E', '': 'L', '': 'N', '': 'O', '': 'S', '殴': 'Z', '呕': 'Z'
        };
        let slug = text;
        for (const [k, v] of Object.entries(replacements)) {
            slug = slug.replaceAll(k, v);
        }
        return slug.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '');
    }

    function copyLinkToClipboard(button, url) {
        const absoluteUrl = new URL(url, window.location.href).href;
        navigator.clipboard.writeText(absoluteUrl).then(() => {
            const tooltip = button.querySelector('.tooltiptext');
            tooltip.innerHTML = "Skopiowano link!";
            setTimeout(() => { tooltip.innerHTML = "Kopiuj link (do Google Calendar)"; }, 2000);
        }).catch(err => {
            alert("Nie udao si skopiowa linku: " + absoluteUrl);
        });
    }

    function renderTable(filteredLocations) {
        const tbody = document.querySelector('#clubs-table tbody');
        tbody.innerHTML = '';

        // Sort clubs by name
        filteredLocations.sort((a, b) => a.club.localeCompare(b.club));

        filteredLocations.forEach(loc => {
            const row = document.createElement('tr');
            
            // Cell 1: Club
            const cellClub = document.createElement('td');
            let clubHtml = `<strong>${loc.club}</strong><br><small>${loc.location || ''}</small>`;
            if (loc.website) clubHtml += `<br><a href="${loc.website}" target="_blank">Strona WWW</a>`;
            cellClub.innerHTML = clubHtml;
            
            // Cell 2: Nearest competition
            const cellNext = document.createElement('td');
            const today = new Date();
            today.setHours(0,0,0,0);
            
            // Parse dates and sort
            const upcoming = loc.competitions
                .map(c => ({...c, parsedDate: parseDate(c.date)}))
                .filter(c => c.parsedDate && c.parsedDate >= today)
                .sort((a, b) => a.parsedDate - b.parsedDate);
            
            if (upcoming.length > 0) {
                const next = upcoming[0];
                cellNext.innerHTML = `<strong>${next.parsedDate.toLocaleDateString()}</strong><br>${next.name}`;
            } else {
                cellNext.innerHTML = '<span style="color: #999;">Brak nadchodzcych zawod贸w w tym roku</span>';
            }

            // Cell 3: Calendar
            const cellCal = document.createElement('td');
            if (loc.competitions.length > 0) {
                const slug = generateSlug(loc.club);
                const icsUrl = `calendars/${slug}.ics`;
                
                // Button container
                const btnContainer = document.createElement('div');
                btnContainer.style.display = 'flex';
                btnContainer.style.gap = '5px';
                btnContainer.style.flexDirection = 'column';

                // Download Button
                const downloadBtn = document.createElement('a');
                downloadBtn.href = icsUrl;
                downloadBtn.className = 'ical-btn';
                downloadBtn.style.textDecoration = 'none';
                downloadBtn.style.textAlign = 'center';
                downloadBtn.innerHTML = '猬锔 Pobierz plik .ics';
                downloadBtn.download = `${slug}.ics`;
                
                // Copy Link Button
                const copyBtn = document.createElement('button');
                copyBtn.className = 'ical-btn tooltip secondary';
                copyBtn.innerHTML = ' Kopiuj link<span class="tooltiptext">Kopiuj link (do Google Calendar)</span>';
                copyBtn.onclick = function() { copyLinkToClipboard(this, icsUrl); };

                btnContainer.appendChild(downloadBtn);
                btnContainer.appendChild(copyBtn);
                cellCal.appendChild(btnContainer);
            } else {
                cellCal.textContent = "-";
            }

            row.appendChild(cellClub);
            row.appendChild(cellNext);
            row.appendChild(cellCal);
            tbody.appendChild(row);
        });
    }

    function displayLocations(filteredLocations) {
        markers.clearLayers();
        filteredLocations.forEach(loc => {
            if (loc.latitude && loc.longitude) {
                let popupContent = `<b>${loc.club}</b><br>${loc.location}<br>`;
                if (loc.website) {
                    popupContent += `<a href="${loc.website}" target="_blank">Strona klubu</a><br>`;
                }
                popupContent += `<hr>`;
                
                // Show up to 3 upcoming competitions in popup
                const today = new Date();
                today.setHours(0,0,0,0);
                const upcoming = loc.competitions
                    .map(c => ({...c, parsedDate: parseDate(c.date)}))
                    .filter(c => c.parsedDate && c.parsedDate >= today)
                    .sort((a, b) => a.parsedDate - b.parsedDate)
                    .slice(0, 3);

                if(upcoming.length > 0) {
                    upcoming.forEach(comp => {
                        popupContent += `<b>${comp.name}</b><br><i>${comp.date}</i><br>`;
                        if(comp.regulation_link) {
                            popupContent += `<a href="${comp.regulation_link}" target="_blank">Regulamin</a><br>`;
                        }
                    });
                } else {
                    popupContent += "<i>Brak nadchodzcych zawod贸w.</i>";
                }
                
                L.marker([loc.latitude, loc.longitude])
                    .addTo(markers)
                    .bindPopup(popupContent);
            }
        });
        
        renderTable(filteredLocations);
    }

    function getSelectedClubs() {
        const checkboxes = document.querySelectorAll('#club-checkboxes input[type="checkbox"]');
        const selected = [];
        checkboxes.forEach(cb => {
            if (cb.checked) selected.push(cb.value);
        });
        return selected;
    }

    function applyFilters() {
        const selectedClubs = getSelectedClubs();
        const startDateValue = document.getElementById('start-date').value;
        const endDateValue = document.getElementById('end-date').value;
        const startDate = startDateValue ? new Date(startDateValue) : null;
        const endDate = endDateValue ? new Date(endDateValue) : null;
        
        if(startDate) startDate.setHours(0,0,0,0);
        if(endDate) endDate.setHours(23,59,59,999);

        const filteredLocations = locations.filter(loc => {
            // Club filter
            if (!selectedClubs.includes(loc.club)) return false;

            // Date filter (if any date is set)
            if (!startDate && !endDate) return true;

            return loc.competitions.some(comp => {
                const compDate = parseDate(comp.date);
                if (!compDate) return false;
                if (startDate && endDate) return compDate >= startDate && compDate <= endDate;
                if (startDate) return compDate >= startDate;
                if (endDate) return compDate <= endDate;
                return false;
            });
        });
        displayLocations(filteredLocations);
    }

    function selectAllClubs(checked) {
        const checkboxes = document.querySelectorAll('#club-checkboxes input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = checked);
        applyFilters(); // Auto refresh
    }

    function resetMapView() {
        map.setView(initialCenter, initialZoom);
    }

    function showUserLocation() {
        if (!navigator.geolocation) {
            alert("Twoja przegldarka nie wspiera geolokalizacji.");
            return;
        }
        navigator.geolocation.getCurrentPosition(position => {
            const { latitude: lat, longitude: lon } = position.coords;
            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
            }
            userLocationMarker = L.marker([lat, lon]).addTo(map)
                .bindPopup('Twoja lokalizacja').openPopup();
            map.setView([lat, lon], 13);
        }, () => {
            alert('Nie mo偶na pobra Twojej lokalizacji.');
        });
    }
    
    function setDateRange(range) {
        const today = new Date();
        let firstDay, lastDay;

        switch (range) {
            case 'next7days':
                firstDay = today;
                lastDay = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                break;
            case 'next14days':
                firstDay = today;
                lastDay = new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000);
                break;
            case 'currentMonth':
                firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                break;
            case 'nextMonth':
                firstDay = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                lastDay = new Date(today.getFullYear(), today.getMonth() + 2, 0);
                break;
            case 'fullYear':
                firstDay = new Date(today.getFullYear(), 0, 1);
                lastDay = new Date(today.getFullYear(), 11, 31);
                break;
        }
        document.getElementById('start-date').value = firstDay.toISOString().split('T')[0];
        document.getElementById('end-date').value = lastDay.toISOString().split('T')[0];
        applyFilters();
    }

    // Load data and initialize
    fetch('competitions.json')
        .then(response => {
            const lastUpdated = response.headers.get('Last-Modified');
            document.getElementById('last-updated').textContent = lastUpdated ? new Date(lastUpdated).toLocaleString() : new Date().toLocaleString();
            return response.json();
        })
        .then(data => {
            locations = data;
            const clubs = [...new Set(locations.map(loc => loc.club))].sort();
            const clubContainer = document.getElementById('club-checkboxes');
            
            clubs.forEach(club => {
                const div = document.createElement('div');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = club;
                checkbox.checked = true; // Default selected
                checkbox.id = `cb-${club.replace(/\s+/g, '-')}`;
                checkbox.onchange = applyFilters; // Live update

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(' ' + club));
                
                clubContainer.appendChild(label);
            });
            displayLocations(locations);
        });

</script>

</body>
</html>